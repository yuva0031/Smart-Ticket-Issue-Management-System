<div class="tickets-container">
  <div class="header">
    <div class="title-row">
      <h2>Service Desk Dashboard</h2>
      <button mat-button color="warn" 
              *ngIf="selectedPriorities().length || selectedStatuses().length" 
              (click)="clearFilters()">
        <mat-icon>filter_alt_off</mat-icon> Reset Filters
      </button>
    </div>
    <mat-form-field appearance="outline" class="search-field" subscriptSizing="dynamic">
      <mat-icon matPrefix>search</mat-icon>
      <input matInput (input)="onSearch($event)" placeholder="Search ID, title, reporter, or assignee...">
    </mat-form-field>
  </div>

  <div class="filter-section">
    <div class="filter-group">
      <span class="filter-label">Priorities</span>
      <mat-chip-listbox multiple>
        <mat-chip-option 
          *ngFor="let p of priorities()" 
          [selected]="selectedPriorities().includes(p.name)"
          (click)="toggleFilter(selectedPriorities, p.name)">
          {{ p.name }}
        </mat-chip-option>
      </mat-chip-listbox>
    </div>

    <div class="filter-group">
      <span class="filter-label">Statuses</span>
      <mat-chip-listbox multiple>
        <mat-chip-option 
          *ngFor="let s of statuses()" 
          [selected]="selectedStatuses().includes(s.name)"
          (click)="toggleFilter(selectedStatuses, s.name)">
          {{ s.name }}
        </mat-chip-option>
      </mat-chip-listbox>
    </div>
  </div>

  <div class="table-wrapper">
    <div class="scroll-container">
      <table mat-table [dataSource]="visibleTickets()" class="mat-elevation-z2">
        
        <ng-container matColumnDef="ticketId">
          <th mat-header-cell *matHeaderCellDef>Key</th>
          <td mat-cell *matCellDef="let t">#{{t.ticketId}}</td>
        </ng-container>

        <ng-container matColumnDef="title">
          <th mat-header-cell *matHeaderCellDef>Summary</th>
          <td mat-cell *matCellDef="let t" class="title-cell"><strong>{{t.title}}</strong></td>
        </ng-container>

        <ng-container matColumnDef="owner">
          <th mat-header-cell *matHeaderCellDef>Reporter</th>
          <td mat-cell *matCellDef="let t">
            <div class="user-stack">
              <span class="name">{{t.owner}}</span>
              <span class="email">{{getUserEmail(t.ownerId)}}</span>
            </div>
          </td>
        </ng-container>

        <ng-container matColumnDef="category">
          <th mat-header-cell *matHeaderCellDef>Category</th>
          <td mat-cell *matCellDef="let t">{{t.category}}</td>
        </ng-container>

        <ng-container matColumnDef="priority">
          <th mat-header-cell *matHeaderCellDef>Priority</th>
          <td mat-cell *matCellDef="let t">
            <span class="prio-dot" [ngClass]="t.priority?.toLowerCase()"></span>
            {{t.priority}}
          </td>
        </ng-container>

        <ng-container matColumnDef="assignedTo">
          <th mat-header-cell *matHeaderCellDef>Assignee</th>
          <td mat-cell *matCellDef="let t">
            <div class="user-stack">
              <span class="name">{{t.assignedTo || 'Unassigned'}}</span>
              <span class="email" *ngIf="t.assignedToId">{{getUserEmail(t.assignedToId)}}</span>
            </div>
          </td>
        </ng-container>

        <ng-container matColumnDef="status">
          <th mat-header-cell *matHeaderCellDef>Status</th>
          <td mat-cell *matCellDef="let t">
            <mat-chip size="small" [color]="t.status === 'Closed' ? 'warn' : 'accent'" selected>{{t.status}}</mat-chip>
          </td>
        </ng-container>

        <ng-container matColumnDef="progress">
          <th mat-header-cell *matHeaderCellDef>SLA</th>
          <td mat-cell *matCellDef="let t">
            <div class="sla-indicator" [ngClass]="getSLAStatus(t.dueDate).class">
              {{ getSLAStatus(t.dueDate).label }}
            </div>
          </td>
        </ng-container>

        <ng-container matColumnDef="dueDate">
          <th mat-header-cell *matHeaderCellDef>Due Date</th>
          <td mat-cell *matCellDef="let t">
            {{ t.dueDate ? (t.dueDate | date:'dd MMM yyyy') : 'No Target' }}
          </td>
        </ng-container>

        <ng-container matColumnDef="createdAt">
          <th mat-header-cell *matHeaderCellDef>Created</th>
          <td mat-cell *matCellDef="let t">
            {{ t.createdAt | date:'dd MMM yyyy' }}
          </td>
        </ng-container>

        <ng-container matColumnDef="actions">
          <th mat-header-cell *matHeaderCellDef></th>
          <td mat-cell *matCellDef="let t">
            <button mat-icon-button [routerLink]="getActionRoute(t)"><mat-icon>visibility</mat-icon></button>
          </td>
        </ng-container>

        <tr mat-header-row *matHeaderRowDef="displayedColumns()"></tr>
        <tr mat-row *matRowDef="let row; columns: displayedColumns()"></tr>
      </table>
    </div>
  </div>

  <mat-paginator 
    [length]="tickets().length" 
    [pageSize]="pageSize()" 
    [pageIndex]="pageIndex()"
    (page)="onPageChange($event)">
  </mat-paginator>
</div>